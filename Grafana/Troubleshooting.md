# Troubleshooting: Commerce Metrics Configuration Details

If you intend to integrate with a 3rd-party system, or for troubleshooting purposes, you might need additional details for the metrics configurations. The following sample commands will help you understand how your system is configured.

The _metrics_ port is defined within the service. For _demoqaauthts-app_, the metrics port maps to 5280.

```
kubectl describe service demoqaauthts-app
Name:                     demoqaauthts-app
Namespace:                commerce
...
Port:                     metrics  5280/TCP
TargetPort:               5280/TCP
NodePort:                 metrics  32313/TCP
Endpoints:                192.168.24.205:5280
```
You can verify the metrics generated by each Commerce container by querying the metrics port directly. The output will help you familiarize with the Prometheus
metrics format, and the metrics produced by each of the HCL Commerce pods.

```
kubectl exec -it demoqaauthts-app-56f94bb494-55qkm -- curl http://localhost:5280/monitor/metrics
# TYPE hclcache_cache_puts_total counter
hclcache_cache_puts_total{cachespace="demoqaauth",name="services/cache/WCCatalogEntryDistributedMapCache",scope="local",source="local",} 9.0
hclcache_cache_puts_total{cachespace="demoqaauth",name="services/cache/WCSystemDistributedMapCache",scope="local",source="miss",} 108.0
hclcache_cache_puts_total{cachespace="demoqaauth",name="services/cache/WCLayoutDistributedMapCache",scope="local",source="miss",} 1.0
hclcache_cache_puts_total{cachespace="demoqaauth",name="services/cache/WCCatalogEntryDistributedMapCache",scope="local",source="miss",} 28.0
```

*Prometheus (not operator):*
If you are using Prometheus annotations, you can verify them with the _kubectl describe pod_ command:

```
  prometheus.io/scrape: "true"
  prometheus.io/path: /monitor/metrics
  prometheus.io/port: "8280"
```

*Prometheus Operator:*
When used with Prometheus Operator, HCL Commerce defines Service Monitors to instruct how often and from which services metrics can be scrapped. 

```
kubectl get servicemonitor -n commerce
```

If the output is empty, meaning the Service Monitors are not defined, ensure you have selected the option during Commerce install. The Service Monitors provide details into which Service is queried, the path and frequency. In other systems you might also see additional details such as authentications.

In this example, the _demoqaauthts-app_ service monitor utilizes the _demoqaauthts-app_ service, and executes the _/monitor/metrics/_ at a frequency of 15 seconds.

```
kubectl describe servicemonitor demoqaauthts-app -n commerce demoqaauthts-app
Spec:
  Endpoints:
    Interval:  15s
    Path:      /monitor/metrics
    Port:      metrics
  Namespace Selector:
    Match Names:
      commerce
  Selector:
    Match Labels:
      Component:  demoqaauthts-app
```

If they are consumed correctly, you should be able to query these metrics with Grafana or the Prometheus UI. If metrics are missing, ensure Prometheus is correctly scraping the Commerce pods. The Prometheus console provides details for the scraping process, and lists healthy and unhealthy endpoints. 

In the Prometheus console see the menu items: _Status > Targets_ and _Status > Service Discovery_ for ServiceMonitors.
If the Commerce service monitors are defined, but are not listed, validate the Prometheus configuration to ensure the Commerce monitors are included: 

```
kubectl edit prometheus -n monitoring
```

Validate the following two configurations: By default Prometheus only looks at Service Monitors within its namespace or with the release: prometheus label, and this
excludes the Commerce Service Monitors.

```
  serviceMonitorNamespaceSelector: {}
  serviceMonitorSelector: {}
```

